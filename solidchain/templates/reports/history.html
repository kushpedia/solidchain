{% extends 'base.html' %}

{% block title %}Report History - SolidChain{% endblock %}
{% load humanize %}
{% block content %}
<!-- Header -->
<div class="card-mobile mb-4">
    <div class="card-body-mobile">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h4 fw-bold mb-1">Report History</h1>
                <p class="text-muted mb-0 text-small-mobile">
                    <i class="bi bi-clock-history me-1"></i>
                    View all generated reports
                </p>
            </div>
            <div class="text-end">
                <div class="fw-bold fs-4 text-primary">{{ total_reports }}</div>
                <div class="text-tiny-mobile text-muted">Total Reports</div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Summary -->
<div class="row g-2 mb-4">
    <div class="col-4">
        <div class="stat-card-mobile">
            <div class="stat-number text-primary">{{ total_reports }}</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
    <div class="col-4">
        <div class="stat-card-mobile">
            <div class="stat-number text-success">{{ reports_today }}</div>
            <div class="stat-label">Today</div>
        </div>
    </div>
    <div class="col-4">
        <div class="stat-card-mobile">
            <div class="stat-number text-warning">
                {% with html_reports=reports|filter_by_format:"html" %}
                    {{ html_reports|length }}
                {% endwith %}
            </div>
            <div class="stat-label">HTML</div>
        </div>
    </div>
</div>

<!-- Filter Options -->
<div class="card-mobile mb-4">
    <div class="card-body-mobile">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-funnel me-2"></i>
            Filter Reports
        </h5>
        
        <div class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchReports" placeholder="Search reports...">
                </div>
            </div>
            <div class="col-md-6">
                <select class="form-control" id="filterType">
                    <option value="all">All Report Types</option>
                    <option value="monthly">Monthly Collection</option>
                    <option value="member">Member Statement</option>
                    <option value="outstanding">Outstanding Payments</option>
                    <option value="fines">Fines Summary</option>
                </select>
            </div>
        </div>
        
        <div class="row g-3 mt-2">
            <div class="col-md-6">
                <select class="form-control" id="filterFormat">
                    <option value="all">All Formats</option>
                    <option value="html">HTML</option>
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                </select>
            </div>
            <div class="col-md-6">
                <select class="form-control" id="filterDate">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Reports List -->
<div class="card-mobile">
    <div class="card-header-mobile d-flex align-items-center justify-content-between">
        <div>
            <i class="bi bi-file-earmark-text me-2"></i>
            Generated Reports
        </div>
        <span class="badge bg-primary">{{ reports.count }} report{{ reports.count|pluralize }}</span>
    </div>
    <div class="card-body-mobile p-0">
        {% if reports %}
        <div class="list-group list-group-flush" id="reportsList">
            {% for report in reports %}
            <div class="list-group-item border-0 px-3 py-3 report-item" 
                 data-type="{{ report.report_type }}"
                 data-format="{{ report.format }}"
                 data-date="{{ report.generated_at|date:'Y-m-d' }}">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                            style="width: 50px; height: 50px; background: 
                                {% if report.report_type == 'monthly' %}#e7f6ff
                                {% elif report.report_type == 'member' %}#e7ffe6
                                {% elif report.report_type == 'outstanding' %}#fff0e6
                                {% else %}#ffe6e6
                                {% endif %}">
                            {% if report.report_type == 'monthly' %}
                                <i class="bi bi-calendar-check text-primary fs-5"></i>
                            {% elif report.report_type == 'member' %}
                                <i class="bi bi-person text-success fs-5"></i>
                            {% elif report.report_type == 'outstanding' %}
                                <i class="bi bi-clock text-warning fs-5"></i>
                            {% else %}
                                <i class="bi bi-cash-coin text-danger fs-5"></i>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h6 class="fw-bold mb-0">{{ report.get_report_type_display }}</h6>
                            <div>
                                <span class="badge-mobile bg-light text-dark me-2">
                                    {{ report.get_format_display }}
                                </span>
                                <span class="badge-mobile 
                                    {% if report.report_type == 'monthly' %}badge-primary-mobile
                                    {% elif report.report_type == 'member' %}badge-success-mobile
                                    {% elif report.report_type == 'outstanding' %}badge-warning-mobile
                                    {% else %}badge-danger-mobile
                                    {% endif %}">
                                    {{ report.report_type|title }}
                                </span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between text-small-mobile text-muted mb-2">
                            <span>
                                <i class="bi bi-person me-1"></i>
                                {{ report.generated_by.get_full_name|default:report.generated_by.username }}
                            </span>
                            <span>
                                <i class="bi bi-calendar me-1"></i>
                                {{ report.generated_at|date:"M d, Y H:i" }}
                            </span>
                        </div>
                        
                        {% if report.parameters %}
                        <div class="text-tiny-mobile text-muted">
                            <i class="bi bi-gear me-1"></i>
                            {% if report.report_type == 'monthly' and report.parameters.month_name %}
                                Month: {{ report.parameters.month_name }}
                            {% elif report.report_type == 'member' and report.parameters.member_name %}
                                Member: {{ report.parameters.member_name }}
                            {% elif report.report_type == 'outstanding' and report.parameters.month_name %}
                                Month: {{ report.parameters.month_name }}
                            {% elif report.parameters.start_date and report.parameters.end_date %}
                                Period: {{ report.parameters.start_date }} to {{ report.parameters.end_date }}
                            {% else %}
                                Custom parameters
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="mt-2">
                            {% if report.format == 'html' %}
                            <a href="#" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                                View Again
                            </a>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="copyReportInfo('{{ report.get_report_type_display }}', '{{ report.generated_at|date:"M d, Y H:i" }}')">
                                <i class="bi bi-clipboard"></i>
                                Copy Info
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% if not forloop.last %}
            <hr class="my-0 mx-3">
            {% endif %}
            {% endfor %}
        </div>
        
        <!-- No Results Message (hidden by default) -->
        <div id="noResults" class="text-center py-5" style="display: none;">
            <i class="bi bi-search display-4 text-muted mb-3"></i>
            <p class="text-muted">No reports match your filters.</p>
            <button class="btn btn-outline-primary btn-sm" onclick="clearFilters()">
                <i class="bi bi-x-circle"></i>
                Clear Filters
            </button>
        </div>
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-file-earmark-text display-4 text-muted mb-3"></i>
            <p class="text-muted">No reports generated yet.</p>
            <p class="text-small-mobile text-muted">
                <a href="{% url 'reports:dashboard' %}" class="text-primary">
                    <i class="bi bi-arrow-right me-1"></i>
                    Go to Reports Dashboard to generate your first report
                </a>
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Stats -->
<div class="card-mobile mt-4">
    <div class="card-body-mobile">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-graph-up me-2"></i>
            Report Statistics
        </h5>
        
        <div class="row g-3">
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="fw-bold fs-4 text-primary">
                        {% with monthly_reports=reports|filter_by_type:"monthly" %}
                            {{ monthly_reports|length }}
                        {% endwith %}
                    </div>
                    <div class="text-tiny-mobile text-muted">Monthly</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="fw-bold fs-4 text-success">
                        {% with member_reports=reports|filter_by_type:"member" %}
                            {{ member_reports|length }}
                        {% endwith %}
                    </div>
                    <div class="text-tiny-mobile text-muted">Member</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="fw-bold fs-4 text-warning">
                        {% with outstanding_reports=reports|filter_by_type:"outstanding" %}
                            {{ outstanding_reports|length }}
                        {% endwith %}
                    </div>
                    <div class="text-tiny-mobile text-muted">Outstanding</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="fw-bold fs-4 text-danger">
                        {% with fines_reports=reports|filter_by_type:"fines" %}
                            {{ fines_reports|length }}
                        {% endwith %}
                    </div>
                    <div class="text-tiny-mobile text-muted">Fines</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-grid gap-2 mt-4">
    <a href="{% url 'reports:dashboard' %}" class="btn btn-primary-mobile btn-mobile">
        <i class="bi bi-bar-chart"></i>
        Back to Reports Dashboard
    </a>
    <button class="btn btn-outline-primary btn-mobile" onclick="exportHistory()">
        <i class="bi bi-download"></i>
        Export History
    </button>
</div>

<!-- Custom Template Filters (add to template tags or in template) -->
<script>
// Simple template filters for counting
const reports = {{ reports|safe }};
</script>

<!-- JavaScript for Filtering -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchReports');
    const typeFilter = document.getElementById('filterType');
    const formatFilter = document.getElementById('filterFormat');
    const dateFilter = document.getElementById('filterDate');
    const reportItems = document.querySelectorAll('.report-item');
    const noResults = document.getElementById('noResults');
    
    function filterReports() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = typeFilter.value;
        const selectedFormat = formatFilter.value;
        const selectedDate = dateFilter.value;
        
        let visibleCount = 0;
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const monthAgo = new Date();
        monthAgo.setDate(monthAgo.getDate() - 30);
        
        reportItems.forEach(item => {
            const type = item.getAttribute('data-type');
            const format = item.getAttribute('data-format');
            const date = item.getAttribute('data-date');
            const text = item.textContent.toLowerCase();
            
            // Check type filter
            const typeMatch = selectedType === 'all' || type === selectedType;
            
            // Check format filter
            const formatMatch = selectedFormat === 'all' || format === selectedFormat;
            
            // Check date filter
            let dateMatch = true;
            if (selectedDate === 'today') {
                dateMatch = date === today;
            } else if (selectedDate === 'week') {
                dateMatch = new Date(date) >= weekAgo;
            } else if (selectedDate === 'month') {
                dateMatch = new Date(date) >= monthAgo;
            }
            
            // Check search term
            const searchMatch = searchTerm === '' || text.includes(searchTerm);
            
            // Show/hide based on all filters
            if (typeMatch && formatMatch && dateMatch && searchMatch) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
    
    // Add event listeners
    searchInput.addEventListener('input', filterReports);
    typeFilter.addEventListener('change', filterReports);
    formatFilter.addEventListener('change', filterReports);
    dateFilter.addEventListener('change', filterReports);
    
    // Initialize filters
    filterReports();
});

function copyReportInfo(type, date) {
    const text = `Report: ${type}\nGenerated: ${date}\n\nFrom SolidChain Reports`;
    
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

function clearFilters() {
    document.getElementById('searchReports').value = '';
    document.getElementById('filterType').value = 'all';
    document.getElementById('filterFormat').value = 'all';
    document.getElementById('filterDate').value = 'all';
    
    // Trigger filter function
    const event = new Event('change');
    document.getElementById('filterType').dispatchEvent(event);
}

function exportHistory() {
    alert('Export functionality will be implemented in the next phase.');
    // This would generate a CSV/Excel file of the report history
}

// Custom template filters (simplified version)
function filterByType(reports, type) {
    return reports.filter(r => r.report_type === type).length;
}

function filterByFormat(reports, format) {
    return reports.filter(r => r.format === format).length;
}
</script>

<!-- Custom CSS for badges -->
<style>
.badge-primary-mobile {
    background-color: rgba(67, 97, 238, 0.15);
    color: #4361ee;
}

.badge-success-mobile {
    background-color: rgba(76, 201, 240, 0.15);
    color: #0a58ca;
}

.badge-warning-mobile {
    background-color: rgba(248, 150, 30, 0.15);
    color: #fd7e14;
}

.badge-danger-mobile {
    background-color: rgba(247, 37, 133, 0.15);
    color: #dc3545;
}

.report-item {
    transition: all 0.3s ease;
}

.report-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}
</style>

<!-- Add this to your template tags or create a custom filter -->
{% comment %}
You'll need to create custom template filters for filter_by_type and filter_by_format
Or use the JavaScript version above
{% endcomment %}
{% endblock %}