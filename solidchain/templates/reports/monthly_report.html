{% extends 'base.html' %}

{% block title %}{{ report_title }} - SolidChain{% endblock %}
{% load humanize %}
{% block content %}
<!-- Report Header -->
<div class="card-mobile mb-4">
    <div class="card-body-mobile">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h4 fw-bold mb-1">{{ report_title }}</h1>
                <p class="text-muted mb-0 text-small-mobile">
                    <i class="bi bi-calendar-check me-1"></i>
                    Monthly Collection Report
                </p>
            </div>
            <div class="text-end">
                <div class="fw-bold fs-4 text-primary">
                    KSh {{ stats.total_collected|add:stats.total_fines|floatformat:0|intcomma }}
                </div>
                <div class="text-tiny-mobile text-muted">Total Collected</div>
            </div>
        </div>
    </div>
</div>

<!-- Report Metadata -->
<div class="card-mobile mb-4">
    <div class="card-body-mobile">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="text-center p-2">
                    <div class="text-muted text-tiny-mobile">Generated By</div>
                    <div class="fw-bold">{{ generated_by.get_full_name|default:generated_by.username }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-2">
                    <div class="text-muted text-tiny-mobile">Generated On</div>
                    <div class="fw-bold">{{ generated_at|date:"M d, Y H:i" }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-2">
                    <div class="text-muted text-tiny-mobile">Month</div>
                    <div class="fw-bold">{{ month.month|date:"F Y" }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Statistics -->
<div class="row g-2 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card-mobile">
            <div class="stat-number text-primary">{{ stats.paid_members }}/{{ stats.total_members }}</div>
            <div class="stat-label">Paid/Total</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card-mobile">
            <div class="stat-number text-success">KSh {{ stats.total_collected|floatformat:0|intcomma }}</div>
            <div class="stat-label">Contributions</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card-mobile">
            <div class="stat-number text-danger">KSh {{ stats.total_fines|floatformat:0|intcomma }}</div>
            <div class="stat-label">Fines</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card-mobile">
            <div class="stat-number text-warning">{{ stats.collection_rate|floatformat:1 }}%</div>
            <div class="stat-label">Collection Rate</div>
        </div>
    </div>
</div>

<!-- Performance Summary -->
<div class="card-mobile mb-4">
    <div class="card-body-mobile">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-graph-up me-2"></i>
            Performance Summary
        </h5>
        
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="p-3 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold fs-4">{{ stats.on_time_count }}</div>
                            <div class="text-tiny-mobile text-muted">On Time Payments</div>
                        </div>
                        <i class="bi bi-check-circle-fill text-success fs-3"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-3 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold fs-4">{{ stats.late_count }}</div>
                            <div class="text-tiny-mobile text-muted">Late Payments</div>
                        </div>
                        <i class="bi bi-clock-fill text-warning fs-3"></i>
                    </div>
                </div>
            </div>
        </div>
        
		<div class="mb-3">
			<div class="d-flex justify-content-between mb-1">
				<span class="text-small-mobile">On-Time Rate</span>
				<span class="text-small-mobile fw-bold">
					{% if stats.paid_members > 0 %}
						{{ stats.on_time_count }}/{{ stats.paid_members }} 
						({% widthratio stats.on_time_count stats.paid_members 100 %}%)
					{% else %}
						0/0 (0%)
					{% endif %}
				</span>
			</div>
			<div class="progress-mobile">
				<div class="progress-bar-mobile bg-success" 
					style="width: {% if stats.paid_members > 0 %}{% widthratio stats.on_time_count stats.paid_members 100 %}%{% else %}0%{% endif %}">
				</div>
			</div>
		</div>
        
        <div class="text-center">
            <div class="text-muted text-small-mobile">
                <i class="bi bi-info-circle me-1"></i>
                Average Fine: KSh {{ stats.average_fine|floatformat:0|intcomma }}
            </div>
        </div>
    </div>
</div>

<!-- Payments Table -->
<div class="card-mobile mb-4">
    <div class="card-header-mobile d-flex align-items-center justify-content-between">
        <div>
            <i class="bi bi-list-check me-2"></i>
            Payment Details
        </div>
        <span class="badge bg-primary">{{ stats.payments.count }} payment{{ stats.payments.count|pluralize }}</span>
    </div>
    <div class="card-body-mobile p-0">
        {% if stats.payments %}
        <div class="table-responsive">
            <table class="table table-mobile">
                <thead>
                    <tr>
                        <th>Member</th>
                        <th>Paid Date</th>
                        <th>Amount</th>
                        <th>Fine</th>
                        <th>Status</th>
                        <th>Days Late</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in stats.payments %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" 
                                        style="width: 30px; height: 30px; font-size: 12px;">
                                        {{ payment.member.user.first_name|first|default:payment.member.user.username|first|upper }}
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ payment.member.user.get_full_name|default:payment.member.user.username }}</div>
                                    <div class="text-tiny-mobile text-muted">{{ payment.member.user.email|default:"No email" }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ payment.paid_date|date:"M d, Y" }}</td>
                        <td class="fw-bold">KSh {{ payment.amount_paid|floatformat:0|intcomma }}</td>
                        <td>
                            {% if payment.fine_amount > 0 %}
                            <span class="text-danger fw-bold">KSh {{ payment.fine_amount|floatformat:0|intcomma }}</span>
                            {% else %}
                            <span class="text-success">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge-mobile {% if payment.status == 'On Time' %}badge-success-mobile{% else %}badge-warning-mobile{% endif %}">
                                {{ payment.status }}
                            </span>
                        </td>
                        <td>
                            {% if payment.status == 'Late' %}
                            <span class="text-warning">{{ payment.days_late }}</span>
                            {% else %}
                            <span class="text-success">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-light">
                        <td colspan="2" class="fw-bold">TOTALS</td>
                        <td class="fw-bold text-primary">KSh {{ stats.total_collected|floatformat:0|intcomma }}</td>
                        <td class="fw-bold text-danger">KSh {{ stats.total_fines|floatformat:0|intcomma }}</td>
                        <td colspan="2" class="fw-bold text-success">
                            KSh {{ stats.total_collected|add:stats.total_fines|floatformat:0|intcomma }}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-receipt display-4 text-muted mb-3"></i>
            <p class="text-muted">No payments recorded for this month.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Pending Members (if included) -->
<!-- Pending Members (if included) -->
{% if include_pending and stats.pending_members > 0 %}
<div class="card-mobile mb-4">
    <div class="card-header-mobile d-flex align-items-center justify-content-between">
        <div>
            <i class="bi bi-clock-history me-2"></i>
            Pending Payments ({{ stats.pending_members }} members)
        </div>
        <span class="badge bg-warning">Pending</span>
    </div>
    <div class="card-body-mobile">
        <p class="text-muted mb-3">
            <i class="bi bi-info-circle me-1"></i>
            The following members have not yet paid for {{ month.month|date:"F Y" }}
        </p>
        
        <div class="row g-2">
            {% for member in stats.pending_members_list %}
            <div class="col-md-6">
                <div class="d-flex align-items-center p-2 bg-light rounded mb-2">
                    <div class="me-3">
                        <div class="bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" 
                            style="width: 40px; height: 40px;">
                            <i class="bi bi-person text-warning"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">{{ member.user.get_full_name|default:member.user.username }}</div>
                        <div class="text-tiny-mobile text-muted">
                            {% if member.phone %}
                                {{ member.phone }}
                            {% else %}
                                No phone
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-danger">KSh 2,500</div>
                        <div class="text-tiny-mobile text-danger">Due</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-3 text-center">
            <div class="fw-bold text-warning">
                Total Pending: KSh {% widthratio stats.pending_members 1 2500 %}
			</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Fine Details (if shown) -->
{% if show_fine_details and stats.total_fines > 0 %}
<div class="card-mobile mb-4">
    <div class="card-header-mobile">
        <i class="bi bi-calculator me-2"></i>
        Fine Breakdown
    </div>
    <div class="card-body-mobile">
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="p-3 bg-danger bg-opacity-10 rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold fs-4 text-danger">KSh {{ stats.total_fines|floatformat:0|intcomma }}</div>
                            <div class="text-tiny-mobile text-danger">Total Fines Collected</div>
                        </div>
                        <i class="bi bi-cash-coin text-danger fs-3"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-3 bg-warning bg-opacity-10 rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold fs-4 text-warning">{{ stats.late_count }}</div>
                            <div class="text-tiny-mobile text-warning">Members with Fines</div>
                        </div>
                        <i class="bi bi-people text-warning fs-3"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center">
            <div class="text-muted text-small-mobile">
                <i class="bi bi-info-circle me-1"></i>
                Fine rules: 6th-10th = KSh 100/day, 11th+ = KSh 25/day (stops on 5th of next month)
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="card-mobile">
    <div class="card-body-mobile">
        <h5 class="fw-bold mb-3">Report Actions</h5>
        <div class="d-grid gap-2">
            {% if not is_quick_view %}
            <a href="{% url 'reports:monthly_report' %}" class="btn btn-primary-mobile btn-mobile">
                <i class="bi bi-arrow-clockwise"></i>
                Generate Another Report
            </a>
            {% endif %}
            
            <button class="btn btn-outline-primary btn-mobile" onclick="window.print()">
                <i class="bi bi-printer"></i>
                Print Report
            </button>
            
            <a href="{% url 'reports:dashboard' %}" class="btn btn-outline-secondary btn-mobile">
                <i class="bi bi-arrow-left"></i>
                Back to Reports Dashboard
            </a>
        </div>
        
        <div class="text-center mt-3">
            <div class="text-tiny-mobile text-muted">
                <i class="bi bi-shield-check me-1"></i>
                Report ID: MR{{ month.id }}{{ generated_at|date:"YmdHis" }}
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    .bottom-nav, .top-nav, .btn-mobile, .card-header-mobile {
        display: none !important;
    }
    
    body {
        padding: 0;
        background: white;
    }
    
    .card-mobile {
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 10px;
    }
    
    .stat-card-mobile {
        border: 1px solid #ddd;
    }
    
    .container-mobile {
        max-width: 100%;
        padding: 0;
    }
    
    a {
        text-decoration: none !important;
        color: black !important;
    }
}
</style>
{% endblock %}